<!DOCTYPE html>
<html>
<head>
	<script src="//cdn.bootcss.com/require.js/2.1.15/require.min.js"></script>
<script>
require.config({
	paths: {
		jquery: 'http://cdn.bootcss.com/jquery/2.1.3/jquery.min',
		jqueryMobile: "http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min",
		jqueryCookie: "http://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min",
		jqueryLazyload: "http://cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min",
		
		swiper: "http://www.idangero.us/swiper/dist/js/swiper.min",
		bootstrap: "http://cdn.bootcss.com/bootstrap/3.3.2/js/bootstrap.min",
		bootstrapDatetime: "http://www.malot.fr/bootstrap-datetimepicker/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js?t=20130302&",

	},
	shim: {
		swiper: {
			exports: "Swiper"
		},
		bootstrap:{
			deps: ['jquery']
		},
		bootstrapDatetime: {
			deps: ["bootstrap"]
		},
		jweixin: {
			exports: "wx"
		},
		mRefresh: {
			deps: ['zepto'],
			exports: "mRefresh"
		},
		zepto: {
			exports: "Zepto"
		},
		gaodeMap: {
			exports: "AMap"
		}
		
	},
	waitSeconds: 15
});
</script>
	<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="http://www.malot.fr/bootstrap-datetimepicker/bootstrap-datetimepicker/css/bootstrap-datetimepicker.css">
</head>
<body>
	<form id="form-search">
		<label>
			项目
			<select name="project">
				<option value="toomao_mobile">toomao_mobile</option>
				<option value="toomao_provider">toomao_provider</option>
				<option value="toomao_provider_m">toomao_provider_m</option>
				<option value="toomao_api">toomao_api</option>
				<option value="toomao_extend">toomao_extend</option>
			</select>
		</label>
		<label>
			日志等级
			<select name="level">
				<option value="ALL">ALL</option>
				<option value="DEBUG">DEBUG</option>
				<option value="INFO">INFO</option>
				<option value="WARN">WARN</option>
				<option value="ERROR">ERROR</option>
			</select>
		</label>
		<label>
			类名
			<input class="" name="className" value="ALL">
		</label>
		<label>
			内容
			<input class="" name="msg" value="ALL">
		</label>
		<label>
			开始时间
			<input size="16" type="text" name="startT" value="" readonly class="form_datetime">
		</label>
		<label>
			结合时间
			<input size="16" type="text" name="endT" value="" readonly class="form_datetime">
		</label>
		<button>搜索</button>
 	</form>
	<table id="table-show" class="table table-striped">
		<tr>
<!-- 			<th>id</th> -->
			<th>level</th>
			<th>class</th>
			<th>detail</th>
			<th>msg</th>
			<th style="width: 85px;">time</th>
		</tr>
	</table>
<script>
require(["jquery", "bootstrap", "bootstrapDatetime"], function($){

	
	
	function formatDate(timestamp) {
		
		var d = new Date(timestamp);
		
		var s = (d.getMonth() + 1) + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes();
		return s;
	}
	function getParams(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
		var r = window.location.search.substr(1).match(reg);
		if (r != null)
			return unescape(r[2]);
		return null;
	}
	
	function init(){
		$("select[name='project'] option[value='" + getParams("project") + "']").attr("selected", true);
		$("select[name='level'] option[value='" + getParams("level") + "']").attr("selected", true);
		if (getParams("className") != undefined)
			$("input[name='className']").val(getParams("className"));
		if (getParams("msg") != undefined)
			$("input[name='msg']").val(getParams("msg"));
		if (getParams("startT") != undefined)
			$("input[name='startT']").val(getParams("startT"));
		if (getParams("endT") != undefined)
			$("input[name='endT']").val(getParams("endT"));
	}
	
	init();
	// 选择日期
	$(".form_datetime").datetimepicker({format: 'yyyy-mm-dd hh:ii'});
	
	if (getParams("project") != undefined && getParams("project") != "") {
		// 显示日志
		$.ajax({  
			url:"http://127.0.0.1:3000/MongoDB/logs/" + getParams("project"),
			/* url:"http://logs.toomao.com/MongoDB/logs/" + getParams("project"), */  
			dataType:'jsonp',
			data: 'options=' + getParams("options"),
			success:function(result) {  
				for(var i in result) {  
					var html = "<tr><td>"
					var v = result[i];
				/* 	html += v["_id"] + "</td><td>"; */
					html += v["level"] + "</td><td>";
					html += v["className"] + "</td><td>";
					html += v["detail"] + "</td><td>";
					html += v["msg"] + "</td><td>";
					html += formatDate(v["_time"]) + "</td></tr>";
					$("#table-show").append(html);
				}  
			}
		});
	}
	
	// 搜索按钮
	$("#form-search button").click(function(e){
		var options = "{";
		
		// level
		var t = $("select[name='level']").val();
		if (t != "ALL")
			options += (options == "{" ? "": ",") + 'level:"' + t + '"';
		
		
		// className
		t = $("input[name='className']").val();
		if (t != "ALL")
			options += (options == "{" ? "": ",") + 'className:/' + t + '/';
			
		// msg
		t = $("input[name='msg']").val();
		if (t != "ALL")
			options += (options == "{" ? "": ",") + 'msg:/' + t + '/';
			
		
		var st = $("input[name='startT']").val(),
			et = $("input[name='endT']").val();
		// 什么时间开始
		if (st != "" && et == "") {
			options += (options == "{" ? "": ",") + '_time:{$gt:' + new Date(st).getTime() + '}';
		}
		// 什么时间结束
		if ($("input[name='startT']").val() == "" && $("input[name='endT']").val() != "") {
			options += (options == "{" ? "": ",") + '_time:{$lt:' + new Date(et).getTime() + '}';
		}
		// 时间区间
		if ($("input[name='startT']").val() != "" && $("input[name='endT']").val() != "") {
			options += (options == "{" ? "": ",") + '_time:{$gt:' + new Date(st).getTime() + ',$lt:' + new Date(et).getTime() + '}';
		}
		options += "}";
		location.href = location.pathname + "?options=" + options + 
			"&project=" + $("select[name='project']").val() + 
			"&level=" + $("select[name='level']").val() +
			"&className=" + $("input[name='className']").val() +
			"&startT=" + $("input[name='startT']").val() +
			"&endT=" + $("input[name='endT']").val() +
			"&msg=" + $("input[name='msg']").val();
		e.preventDefault();
	});
});
</script>
</body>
</html>